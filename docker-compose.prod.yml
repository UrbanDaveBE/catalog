version: '3.8'

services:
  catalog-db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=catalog
      - POSTGRES_PASSWORD=catalog
      - POSTGRES_DB=catalog
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data

  catalog:
    image: "urbandave/catalog:14" # ERSETZEN 42 DURCH DIE ECHTE RUN_NUMBER
    ports:
      - "8080:8080"
    restart: on-failure
    depends_on:
      - catalog-db  # Warte, bis die DB läuft
    environment:
      # Wir überschreiben die application.properties von außen:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://catalog-db:5432/catalog
      - SPRING_DATASOURCE_USERNAME=catalog
      - SPRING_DATASOURCE_PASSWORD=catalog
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update

  order:
    image: "urbandave/order:50" # ERSETZEN DURCH DIE ECHTE RUN_NUMBER
    ports:
      - "8081:8081"
    restart: on-failure
    environment:
      - catalog.base.url=http://catalog:8080
    depends_on:
      - catalog
  # --- Monitoring Stack (NEU) ---
  prometheus:
    image: prom/prometheus
    ports:
      - "9090:9090"
    volumes:
      # Wir müssen eine Config-Datei in den Container mappen
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      # Standard-Startbefehl + Config-Pfad
      - '--config.file=/etc/prometheus/prometheus.yml'

  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"
    depends_on:
      - prometheus

volumes:
  postgres-data: